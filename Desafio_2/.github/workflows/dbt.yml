name: dbt

# ==============================================================================
# Validaci贸n en PRs + Deploy opcional en merge a main
# ==============================================================================

on:
  pull_request:
    branches: [main]
    paths:
      - 'dbt/**'
      - '.github/workflows/dbt.yml'
  push:
    branches: [main]
    paths:
      - 'dbt/**'
      - '.github/workflows/dbt.yml'
  workflow_dispatch:
    inputs:
      run_models:
        description: 'Ejecutar dbt run (consumo BigQuery)'
        required: true
        default: 'false'
        type: boolean

env:
  GCP_PROJECT_ID: orbidi-challenge
  DBT_PROFILES_DIR: ${{ github.workspace }}/dbt

jobs:
  # ==============================================================================
  # Validaci贸n en PRs
  # ==============================================================================
  validate:
    name: Validate dbt
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dbt dependencies
        working-directory: dbt
        run: uv sync

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: dbt debug
        working-directory: dbt
        run: uv run dbt debug --profiles-dir .

      - name: dbt compile
        working-directory: dbt
        run: uv run dbt compile --profiles-dir .

      - name: dbt test (validaci贸n de schema)
        working-directory: dbt
        run: uv run dbt test --profiles-dir .
        continue-on-error: true

      - name: Upload compiled SQL
        uses: actions/upload-artifact@v4
        with:
          name: dbt-compiled
          path: dbt/target/compiled/
          retention-days: 7

  # ==============================================================================
  # Deploy en merge a main (opcional - requiere aprobaci贸n manual)
  # ==============================================================================
  deploy:
    name: Deploy dbt models
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.run_models == 'true')
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dbt dependencies
        working-directory: dbt
        run: uv sync

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: dbt run
        working-directory: dbt
        run: uv run dbt run --profiles-dir .

      - name: dbt test
        working-directory: dbt
        run: uv run dbt test --profiles-dir .

      - name: Apply Policy Tags
        working-directory: scripts
        run: |
          chmod +x apply_policy_tags.sh
          ./apply_policy_tags.sh
        continue-on-error: true

      - name: Upload run results
        uses: actions/upload-artifact@v4
        with:
          name: dbt-run-results
          path: |
            dbt/target/run_results.json
            dbt/target/manifest.json
          retention-days: 30
